# -*- coding: utf-8 -*-
"""Pooh_excel_to_ddl.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1KK52g5ldAT2Ev9NTEwLA8bZr3cxNBzR9
"""

import sys
import time
import pandas as pd

boiler_plate = f"""
/*
Created      : {time.strftime("%Y-%m-%d %H:%M")}
Generated_by : Python
*/

"""

def create_data_type(row):
    s = row[0]
    if "%p1" in s:
        s = s.replace("%p1",str(int(row[1])))
    if "%p2" in s:
        s = s.replace("%p2",str(int(row[2])))
    return s

def create_sql_string(entity_name,column_name,is_ordered,index,distribution,distribution_key,data_types,nullable):
    
    columns_str = []
    for name,data_type,nul in zip(column_name,data_types,nullable):
        columns_str.append(f"[{name}] {data_type} {'NOT NULL' if nul == 'N' else 'NULL'}")
    columns_str = ",\n ".join(columns_str)
    
    str = f"""CREATE TABLE [IF NOT EXISTS] [{entity_name}]
(
 {columns_str}
);
    
"""

    return str

## Read Data
df = pd.read_excel("/content/FACT_DOCUMENT.xlsx") ## File name

df["New Data types"] = df[['Target data type', 'Length', 'Precision']].apply(create_data_type,axis=1)
df.drop(['Target data type', 'Length', 'Precision'],axis=1,inplace=True)
grouped_df = df.groupby("Target Table Name").agg(list)

## Saving the SQL Data
with open("fact_document_output.SQL", "w") as f:
    f.write(boiler_plate)
    for index, row in grouped_df.iterrows():
        sql_command = create_sql_string(index,\
                                        row["Target column name"],\
                                        row["Ordered"][0],\
                                        row["Index"][0],\
                                        row["Distribution"][0],\
                                        row["DISTRIBUTION KEY"][0],\
                                        row["New Data types"],\
                                        row["Nullable"])
        f.write(f"-- Table {index} \n\n")
        f.write(sql_command)

